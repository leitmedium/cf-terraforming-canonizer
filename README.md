# Cloudflare DNS Terraform Canonizer

This tool helps canonize Terraform configurations generated by
[cf-terraforming](https://github.com/cloudflare/cf-terraforming) by
transforming unreadable auto-generated resource names into consistent, readable
ones that follow a structured naming convention.

## Use Case

When using `cf-terraforming` to migrate existing Cloudflare zones to Terraform,
the resulting files contain unhelpful resource names like:

```
resource "cloudflare_dns_record" "terraform_managed_resource_abcdef123456" {
  ...
}
```
While these names are unique as they rely on the Cloudflare IDs, they are not
canonical when reading terraform code and output during plan and apply.


This tool replaces them with readable names like:

```
resource "cloudflare_dns_record" "A_mail_example_com" {
  ...
}
```

## ✅ Naming Convention

- Format: `<TYPE>_<FQDN>`
- Example: `"mail.example.com"` → `MX_mail_example_com`
- All dots (`.`) and dashes (`-`) are replaced with underscores (`_`)
- Duplicate entries (e.g. multiple MX records) are suffixed (`_2`, `_3`, etc.)

## 🔄 Workflow

1. **Export Terraform code and import commands from Cloudflare** using `cf-terraforming`:

```bash
cf-terraforming generate --zone <ZONE_ID> --resource-type cloudflare_record --token $CLOUDFLARE_API_TOKEN > cf.tf
cf-terraforming import --zone <ZONE_ID> --resource-type cloudflare_record --token $CLOUDFLARE_API_TOKEN > import.sh
```

2. **Canonize the names** using this tool:

```bash
python3 cf-terraforming-canonizer.py cf.tf import.sh
```

This will generate:

- `cf_clean.tf`: Cleaned resource definitions
- `import_clean.sh`: Updated import commands matching the new names

The resulting filenames are currently hard coded.

3. **Import the resources** into Terraform:

Ensure to have only the canonized cf.tf file in your current terraform directory. Feel free to rename it or migrate the content.


```bash
terraform init
bash import_clean.sh
terraform plan
```

The import shell script can probably be deleted after the final successful terraform plan.


## 📁 Files

- `cf-terraforming-canonizer.py` – the transformation script
- `cf.tf` – raw output from `cf-terraforming`
- `import.sh` – original import script from `cf-terraforming`
- `cf_clean.tf` – canonized Terraform resources
- `import_clean.sh` – updated import commands

## 🧪 Requirements

- Python 3.6+
- Terraform installed
- Valid `cf-terraforming` export files
